<template>
<div>
    <div class="fixed-action-btn">
        <router-link to="/new" class="btn-floating btn-large red">
            <i class="fa fa-plus"></i>
        </router-link>
    </div>
    <div class="row" v-for="i in Math.ceil(products.length / 3)" v-bind:key="i">
        <div v-for="product in products.slice((i - 1) * 3, i * 3)" v-bind:key="product.id" class="col-md-4 col-6 my-1">
            <b-card 
                v-bind:img-src="product.thumbUrl"
                img-fluid
                img-alt="image"
                overlay>
            <!-- img-src="https://picsum.photos/400/400/?image=41"
                 {{item}} -->
                <div slot="footer">
                    <small class="text-muted">{{product.name}}<br />{{product.price}} VND</small>   
                </div>
                    <router-link v-bind:to="{name: 'view-product', params: {product_id: product.product_id}}" class="secondary-content">
                        <i class="fa fa-eye"></i>
                    </router-link>
                    <router-link v-bind:to="{name: 'edit-product', params: {product_id: product.product_id}}" class="secondary-content">
                        <i class="fa fa-pencil"></i>
                    </router-link>
                    <button @click='addToCart(product)' class='button is-info'><i class="fa fa-cart-arrow-down"></i></button>
            </b-card>
        </div>
    </div>
</div>
</template>

<script>
// storage reference:   gs://vnshoptest.appspot.com          
import firebaseApp from './firebaseInit'
import { mapGetters, mapActions } from 'vuex'

export default {
    name: 'display',
    data () {
        return {
            products: []
            //imageLink: 'https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png'  
        }
    },
    created () {
        var db = firebaseApp.firestore();

        db.collection('products').get().then(querySnapshot => {
            querySnapshot.forEach(doc => {
                var thumbPicture = null
                if(doc.data().thumbUrl == undefined) {
                    thumbPicture = "https://firebasestorage.googleapis.com/v0/b/vnshoptest.appspot.com/o/images%2Fno-image-icon-6.png?alt=media&token=4b4b8e91-6525-4607-b845-b2e8f0ce3b98"
                }else{
                    thumbPicture = doc.data().thumbUrl
                }
                const data = {
                    'product_id': doc.id,
                    'article_number': doc.data().article_number,
                    'barcode': doc.data().barcode,
                    'category': doc.data().category,
                    'colour': doc.data().colour,
                    'description': doc.data().description,
                    'name': doc.data().name,
                    'name_ger': doc.data().name_ger,
                    'price': doc.data().price,
                    'size': doc.data().size,
                    'thumbUrl': thumbPicture,
                    'tags': null
                    // tags
                }
                this.products.push(data)
            })
            this.fetchData()
        }) 
    },
    computed: mapGetters({
        products: 'allProducts',
        length: 'getNumberOfProducts'
    }),
    methods: {
        ...mapActions(['addToCart'])
   /*     fetchData: function () {
           var vm = this

            var storage = firebaseApp.storage("gs://vnshoptest.appspot.com");
            // First we sign in the user anonymously
            firebaseApp.auth().signInAnonymously().then(function() {
                // Once the sign in completed, we get the download URL of the image
                
                vm.products.forEach(product => {
                    var fileName = 'images/' + product.product_id + '_0'
                    var pathReference = storage.ref(fileName)
                    pathReference.getDownloadURL().then(function(url) {
                        // Once we have the download URL, we set it to our img element
                        product.imageUrl = url
                    //    console.log(url);
                    });
                }).catch(function(error) {
                // If anything goes wrong while getting the download URL, log the error
                console.error(error);
                });
            });
        } */
    }
    //  https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png
}
</script>
    